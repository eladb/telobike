<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<script src='/scripts/jquery-1.6.1.min.js' type='text/javascript'></script>
		<script src='/scripts/raphael-min.js' type='text/javascript'></script>
		<script src='/scripts/g.raphael-min.js' type='text/javascript'></script>
		<script src='/scripts/g.line-min.js' type='text/javascript'></script>
		<script src='/scripts/date.format.js' type='text/javascript'></script>
		<script src='/scripts/date.js' type='text/javascript'></script>
		<title>Station History for {{sid}} (in {{city}})</title>

		<script type='text/javascript'>
			$(document).ready(function() {
 				var r = Raphael("graph");
				
				var x_values = [];
				var avail_bike_values = [];
				var update_times = [];
				var i = 0;

				{% for h in history %}
				// station: {{h.sid}} at {{h.last_update}}
				
				if (avail_bike_values[0] != {{h.available_bike}}) {
					x_values.push(i++);
					update_times.unshift('{{h.last_update}}');
					avail_bike_values.unshift({{h.available_bike}});
				}
				
				{% endfor %}

                var lines = r.g.linechart(0, 0, 320, 200, 
					[x_values], [avail_bike_values], 
					{ nostroke: false, axis: "0 0 1 1", symbol: "o", smooth: true });

				for (var i = 0; i < lines.axis[0].text.length; ++i) {
					var item = lines.axis[0].text[i];
					var oldValue = item.attr('text');
					if (parseInt(oldValue) == oldValue) {
						var dateString = update_times[oldValue];
						dateString = dateString.substr(0, dateString.indexOf('.'));
						var time = getDateFromFormat(dateString, 'yyyy-MM-dd HH:mm:s');
						var timezoneOffset = new Date().getTimezoneOffset();
						var date = new Date(time - (timezoneOffset * 60 * 1000));
						item.attr({'text': date.format('shortTime')});
					} else {
						item.attr({'text': ''});
					}
				}				
					
				lines.hoverColumn(function () {
                    //	console.info(this);
                    this.tags = r.set();
					for (var i = 0; i < this.y.length; i++) {
                        this.tags.push(r.g.tag(this.x, this.y[i], this.values[i], 160, 10).insertBefore(this).attr([{fill: "#fff"}, {fill: this.symbols[i].attr("fill")}]));
                    }
                }, function() {
                    this.tags && this.tags.remove();
				});
			});
		</script>
		
	</head>
	
	<body>
		
		<h1 align='center'>Station {{ sid }}: {{ name }}</h1>
		
		<!--
		<table border='1'>
			
			<tr>
				<th>update time</th>
				<th>name</th> 
				<th>location</th>
				<th>available bike</th>
				<th>available spaces</th>
			</tr>
			
			{% for h in history %}
			
			<tr>
				<td>{{h.last_update}}</td>
				<td>{{h.name}}</td>
				<td>{{h.location}}</td>
				<td>{{h.available_bike}}</td>
				<td>{{h.available_spaces}}</td>
			</tr>
			
			{% endfor %}
			
		</table>
		
		<hr/>
		-->
		
		<div id='graph'></div>
		
	</body>
</html>
